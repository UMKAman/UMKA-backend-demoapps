<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: Review.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: Review.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Review.js
 *
 * @description :: TODO: You might write a short summary of how this model works and what it represents here.
 * @docs        :: http://sailsjs.org/documentation/concepts/models-and-orm/models
 */

const _ = require('lodash');
const Promise = require('bluebird');

/**
 * @namespace Review
 * @prop {model} writter user который написал
 * @prop {model} master master которому написали
 * @prop {string} text Текст отзыва
 * @prop {string} rating Рейтинг
 */
module.exports = {

  attributes: {
    writter: { model: 'user', required: true },
    master: { model: 'master', required: true },
    text: { type: 'string' },
    rating: { type: 'string' },
  },
  afterCreate: function (data, cb) {
    if (data.rating &amp;&amp; data.master) {
      Promise.all([
        Review.find({ master: data.master, rating: { '!': null } }).average('rating'),
        Review.count({ master: data.master, rating: { '!': null } }),
        Review.find({ master: data.master, rating: { '!': null } }).groupBy('rating+5-5').sum('rating'),
        Master.findOne({ id: data.master }),
      ])
        .spread((average, count, grouped, master) => {
          master.averageRating = average[0].rating;
          master.voices = count;
          master.ratingsAndCounts = [];
          _.each(grouped, group => {
            master.ratingsAndCounts.push({ [group.group0.toFixed(1)]: group.rating.toFixed(1) / group.group0.toFixed(1) })
          })
          master.ratingsAndCounts = JSON.stringify(master.ratingsAndCounts);
          return master.save();
        }).finally(() => {
          cb();
        })
    } else {
      cb();
    }
  }
};

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="Chat.html">Chat</a></li><li><a href="Currency%2520.html">Currency </a></li><li><a href="FireToken.html">FireToken</a></li><li><a href="Jwt.html">Jwt</a></li><li><a href="Master.html">Master</a></li><li><a href="Messages.html">Messages</a></li><li><a href="Order.html">Order</a></li><li><a href="PortfolioPic.html">PortfolioPic</a></li><li><a href="Protfolio.html">Protfolio</a></li><li><a href="Review.html">Review</a></li><li><a href="serviceMaster.html">serviceMaster</a></li><li><a href="Sms.html">Sms</a></li><li><a href="Specialization.html">Specialization</a></li><li><a href="User.html">User</a></li><li><a href="Workday.html">Workday</a></li><li><a href="Workhour.html">Workhour</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_">_</a></li><li><a href="global.html#admin">admin</a></li><li><a href="global.html">checkCode</a></li><li><a href="global.html">checkSMSCode</a></li><li><a href="global.html#generateNewSMS">generateNewSMS</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon May 29 2017 20:41:39 GMT+0700 (+07)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
